<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lights App</title>
  <!doctype html>
  <html>
  <head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Lights App</title>
    <style>
    html, body { height: 100%; margin: 0; }
    body { font-family: Arial, sans-serif; padding: 40px; display: flex; flex-direction: column; }
    .btn { padding: 18px 28px; font-size: 18px; border: 2px solid #ccc; background: #fff; cursor: pointer; border-radius: 8px; min-width: 160px; }
    .btn:active { transform: translateY(1px); }
    .btn.hidden { display: none; }
    #status { margin-top: 20px; font-size: 20px; font-weight: 600; }
    a.admin { display: block; margin-top: auto; padding-top: 40px; border-top: 1px solid #ccc; text-decoration: none; color: #0066cc; font-size: 16px; cursor: pointer; }
    a.admin:hover { text-decoration: underline; }
    </style>
  </head>
  <body>
    <div id="status">Ready</div>
    <button id="playBtn" class="btn hidden">Play Song</button>
    <button id="nextBtn" class="btn">Next Song</button>
    <a class="admin" href="/admin">Admin Controls</a>

    <script>
      function setStatus(text, isError=false) {
        const status = document.getElementById('status');
        status.textContent = text;
        status.style.color = isError ? 'crimson' : '';
      }

      async function requestPlaySong() {
        try {
          const res = await fetch('/api/single_press');
          const data = await res.json();
          if (data.song) {
            setStatus('Now playing: ' + data.song);
          } else if (data.error) {
            setStatus('Error: ' + data.error, true);
          }
        } catch (err) {
          console.error('Request failed', err);
          setStatus('Request error', true);
        }
      }

      async function requestNextSong() {
        try {
          const res = await fetch('/api/double_press');
          const data = await res.json();
          const btn = document.getElementById('nextBtn');
          if (data.song) {
            setStatus('Now playing: ' + data.song);
            btn.classList.remove('hidden');
          } else if (data.error) {
            setStatus('Error: ' + data.error, true);
          } else {
            setStatus('Next song requested');
          }
        } catch (err) {
          console.error('Request failed', err);
          setStatus('Request error', true);
        }
      }

      document.getElementById('playBtn').addEventListener('click', requestPlaySong);
      document.getElementById('nextBtn').addEventListener('click', requestNextSong);

      // Poll current song every 1 second so multiple clients see the same state
      async function fetchCurrentSong() {
        try {
          const res = await fetch('/api/current_song');
          const data = await res.json();
          const playBtn = document.getElementById('playBtn');
          const nextBtn = document.getElementById('nextBtn');
          if (data.song) {
            setStatus('Now playing: ' + data.song);
            playBtn.classList.add('hidden');
            nextBtn.classList.remove('hidden');
          } else {
            setStatus('Ready');
            playBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
          }
        } catch (err) {
          // ignore polling errors (keep previous state)
          console.debug('Polling current song failed', err);
        }
      }

      // Start polling immediately
      fetchCurrentSong();
      setInterval(fetchCurrentSong, 1000);
    </script>
  </body>
  </html>
